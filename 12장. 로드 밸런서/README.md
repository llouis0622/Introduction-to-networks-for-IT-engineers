# 12장. 로드 밸런서

# 1. 부하 분산이란?

- 동일한 서비스를 하는 다수의 서버 등록되고 사용자로부터 서비스 요청이 오면 로드 밸런서가 받아 사용자별로 다수의 서버에 서비스 요청을 분산시켜 부하 분산
- 서비스를 위한 가상 IP를 하나 제공하고 사용자는 각 서버의 개별 IP 주소가 아닌 동일한 가상 IP를 통해 각 서버로 접근
- 각 서버의 서비스 상태를 체크해 서비스가 가능한 서버로만 사용자 요청 분산
- SLB(Server Load Balancing) : 서버 부하 분산
- FWLB(FireWall Load Balancing) : 방화벽 부하 분산

# 2. 부하 분산 방법

- VIP(Virtual IP), 서비스 IP 주소 : 가상 IP 주소
- 서비스를 제공하는 서버의 IP인 리얼 IP와 로드 밸런서에서 서비스를 대표하는 VIP
- VIP에는 리얼 IP 바인딩, 사용자가 VIP로 서비스 요청하면 해당 VIP에 연결된 리얼 IP로 해당 요청 전달

# 3. 헬스 체크

- 정상적인 서비스 쪽으로만 부하 분산
- 비정상적인 서버는 서비스 그룹에서 제외 → 트래픽 전달 불가

## 1. 헬스 체크 방식

### 1. ICMP

- 단순히 서버가 살아 있는지 여부 체크

### 2. TCP 서비스 포트

- 로드 밸런서에 설정된 서버의 서비스 포트 확인
- 실제 서비스 포트가 아닌 다른 서비스 포트로도 가능

### 3. TCP 서비스 포트 : Half Open

- 초기의 3방향 핸드셰이크와 동일하게 SYN을 보내고 SYN, ACK를 받지만 이후 ACK 대신 RST를 보내 세션 종료

### 4. HTTP 상태 코드

- 로드 밸런서가 서버로 3방향 핸드셰이크를 거치고나서 HTTP를 요청 → 정상적인 상태 코드(200) 응답 여부 체크

### 5. 콘텐츠 확인(문자열 확인)

- 서버로 콘텐츠 요청 → 응답받은 내용 확인 후 지정된 콘텐츠가 정상적으로 응답했는지 여부 확인
- 특정 웹페이지 호출 → 사전에 지정한 문자열이 해당 웹페이지 내에 포함되어 있는지 체크
- 백엔드 상태까지 확인하면서 헬스 체크 수행
- 정상 코드 값도 중복으로 확인
- 문자열 자체를 일반적이 아닌 특정 문자열로 지정해 결과가 정상일 때만 헬스 체크 성공

## 2. 헬스 체크 주기와 타이머

- 주기(Interval)
    - 로드 밸런서에서 서버로 헬스 체크 패킷을 보내는 주기
- 응답 시간(Response)
    - 로드 밸런서에서 서버로 헬스 체크 패킷을 보내고 응답을 기다리는 시간
    - 해당 시간까지 응답이 오지 않으면 실패로 간주
- 시도 횟수(Retries)
    - 로드 밸런서에서 헬스 체크 실패 시 최대 시도 횟수
    - 최대 시도 횟수 이전에 성공 시 시도 횟수 초기화
- 타임아웃(Timeout)
    - 로드 밸런서에서 헬스 체크 실패 시 최대 대기 시간
    - 헬스 체크 패킷을 서버로 전송 → 시간 내에 성공하지 못하면 해당 서버 다운
- 서비스 다운 시의 주기(Dead Interval)
    - 서비스의 기본적인 헬스 체크 주기가 아닌 서비스 다운 시의 헬스 체크 주기
    - 서비스가 죽은 상태에서 헬스 체크 주기를 별도로 더 늘릴 때 사용

# 4. 부하 분산 알고리즘

## 1. 라운드 로빈(Round Robin)

- 특별한 규칙 없이 현재 구성된 장비에 순차적으로 돌아가면서 트래픽 분산
- 모든 장비의 총 누적 세션 수 동일

## 2. 최소 접속 방식(Least Connection)

- 서버가 가진 세션 부하를 확인해 그것에 맞게 부하 분산
- 각 장비의 세션 수를 확인해 현재 세션이 가장 적게 연결된 장비로 서비스 요청 보내는 방식

## 3. 해시(Hash)

- 서버의 부하를 고려하지 않고 클라이언트가 같은 서버에 지속적으로 접속하도록 하기 위해 사용하는 부하 분산 방식
- 같은 알고리즘 사용 → 항상 동일한 결괏값을 가지고 서비스 분산
- 출발지 IP 주소, 목적지 IP 주소, 출발지 서비스 포트, 목적지 서비스 포트
- 세션 유지해야 하는 서비스에 적합
- 해시 + 최소 접속 방식
    - 스티키 옵션을 주어 한 번 접속한 커넥션 지속적으로 유지
    - 처음 들어온 서비스 요청을 세션 테이블에 두고 같은 요청이 들어오면 같은 장비로 분산해 세션 유지

# 5. 로드 밸런서 구성 방식

- 서버로 가는 트래픽이 모두 로드 밸런서를 경유하는지, 경유하지 않아도 되는지에 대한 트래픽 흐름으로 구분
    - 원암(One-Arm) 구성 : 부하 분산을 수행하는 트래픽에 대해서만 로드 밸런서 경유, 부하 분산을 수행하지 않는 트래픽은 로드 밸런서 미경유
    - 인라인(Inline) 구성 : 부하 분산을 포함한 모든 트래픽이 로드 밸런서를 경유

## 1. 원암 구성

- 로드 밸런서가 스위치 옆에 있는 형태
- 서버로 들어가거나 나오는 트래픽이 로드 밸런서를 경유하거나 경유하지 않음
- 부하 분산을 이용한 트래픽인지 여부로 구분
- 로드 밸런서를 이용하는 서비스에 대해서만 로드 밸런서를 경유 → 불필요한 트래픽이 로드 밸런서에 유입되지 않아 로드 밸런서 부하 감소
- 스위치와 로드 밸런서 간의 대역폭 최소화
- 상대적으로 확장 유리

## 2. 인라인 구성

- 로드 밸런서가 스위치에서 서버까지 가는 일직선상 경로에 있는 형태
- 흐르는 경로에 로드 밸런서가 있어서 서버로 향하는 트래픽이 로드 밸런서의 서비스를 받는지 여부와 상관없이 로드 밸런서 모두 통과
- 로드 밸런서 부하 증가

# 6. 로드 밸런서 동작 모드

## 1. 트랜스패런트 모드(Transparent)

- 로드 밸런서가 OSI 2계층 스위치처럼 동작하는 구성
- VIP 주소와 실제 서버가 동일한 네트워크를 사용하는 구성
- 내부적으로 프록시 ARP 이용하는 방식 사용

## 2. 라우티드 모드

- 로드 밸런서가 라우팅 역할을 수행하는 모드
- 사용자 방향(Client Side)과 서버 방향(Server Side)이 서로 다른 네트워크로 분리
- 서버쪽 네트워크를 사설로 구성 → 서버에 직접 접속 방지

## 3. DSR 모드(Direct Server Return)

- 사용자의 요청이 로드 밸런서를 통해 서버로 유입된 후에 다시 로드 밸런서를 통하지 않고 서버가 사용자에게 직접 응답
- 로드 밸런서를 경유하지 않음 → 원암 구성
- L2 DSR : 실제 서버의 네트워크를 로드 밸런서가 가진 경우
- L3 DSR : 실제 서버의 네트워크 대역을 로드 밸런서가 가지지 않은 경우
- 루프백 인터페이스 설정
- 리눅스 커널 파라미터 수정(리눅스)
- 네트워크 설정 변경(윈도우)

# 7. 로드 밸런서 유의사항

## 1. 원암 구성의 동일 네트워크 사용 시

- 로드 밸런서를 거치면서 변경된 IP가 재응답할 때 로드 밸런서를 경유하면서 원래의 IP로 바꾸어 응답해야 하지만 원암 구조에서는 응답 트래픽이 로드 밸런서를 경유하지 않아서 발생

### 1. 게이트웨이를 로드 밸런서로 설정

- 부하 분산이 이루어지는 실제 서버에 대해서는 게이트웨이를 로드 밸런서로 설정
- 물리적으로는 원암 구조이지만 실제 트래픽 플로가 로드 밸런서를 게이트웨이로 사용 → 원암 구조에서 가질 수 있는 로드 밸런서의 부하 감소효과 감소

### 2. Source NAT 사용

- 응답 패킷의 출발지를 실제 서버에서 로드 밸런서에 있는 서비스 IP로 바꾸고 목적지 IP 주소를 로드 밸런서의 IP에서 원래의 사용자 IP로 변경해 사용자에게 응답
- 서비스를 호출한 IP가 하나의 동일한 IP로 보이기 때문에 사용자 구분 어려움
- X-Forwarded-For(XFF)를 사용해 실제 사용자 IP를 확인하는 방법

### 3. DSR 모드

- 사용자의 서비스 요청 트래픽에 대해 별도의 Destination NAT를 수행하지 않고 실제 서버로 서비스 요청 패킷 전송

## 2. 동일 네트워크 내에서 서비스 IP 호출

- 출발지 IP 주소를 로드 밸런서의 IP로 변경하는 Source NAT 방법
- DSR 모드를 사용해 실제 서버에서 로드 밸런서를 거치지 않고 직접 응답
- 부하 분산 서비스를 받는 서버를 로드 밸런서에 직접 연결해 어떤 서비스 요청에 대한 응답이든 물리적으로 로드 밸런서 거침

# 8. HAProxy를 사용한 로드 밸런서 설정

- 일반 서버에서 직접 수행하게 해주는 오픈 소스 기반의 소프트웨어 로드 밸런서
- NFV(Network Function Virtualization)
- 로드 밸런서 서비스 신속 제공
- 가상화나 클라우드 환경에서 로드 밸런서로 사용하기 적합
- 쿠버네티스의 인그레스 컨트롤러(Ingress Controller) 역할

## 1. HAProxy 설정

- 프로세스 전반에 적용되는 값을 설정하는 global 섹션
- 실제 로드 밸런서 수행을 위한 defaults, listen, frontend, backend 섹션
- global 섹션
    - HAProxy 프로세스 전반에 적용되는 설정 값
    - log, daemon, maxconn 등
- defaults 섹션
    - listen 섹션이나 backend 섹션에 설정이 별도로 없을 때 사용하는 설정 값
    - mode, timeout, maxconn 등에 대한 값 지정
- frontend 섹션
    - 실제 서비스에 사용될 가상 IP 관련 설정
    - bind : 가상 IP에서 사용될 서비스 IP
- backend 섹션
    - 가상 IP에서 전달되어 실제 서비스에 사용되는 Real IP에 대한 설정
- listen 섹션
    - frontend와 backend의 동시 설정이 가능한 섹션
    - frontend와 backend를 나누어 설정할 필요가 없을 때는 listen 섹션으로만 설정 가능
    - 상태 및 통계 정보 확인
