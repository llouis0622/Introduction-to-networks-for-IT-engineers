# 4장. 스위치 : 2계층 장비

# 0. 들어가기

- 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는 네트워크 중재자 역할
- MAC 주소 인식, 패킷 전달
- 한 대의 장비에서 논리적으로 네트워크를 분리(VLAN)
- 네트워크 루프 방지(스패닝 트리 프로토콜)

## 💭. 패킷? 프레임?

- PDU(Protocol Data Unit) : 헤더와 데이터를 합친 부분
- 1계층 PDU : 비트(Bits)
- 2계층 PDU : 프레임(Frame)
- 3계층 PDU : 패킷(Packet)
- 4계층 PDU : 세그먼트(Segment)
- 애플리케이션 계층 PDU : 데이터(Data)

# 1. 스위치 장비 동작

- 패킷 전송 시 서로 경합을 없애고 패킷을 동시에 여러 장비가 서로 간섭 없이 통신하도록 도와줌
- 누가 어느 위치에 있는지 파악 → 자신이 알고 있는 위치로 패킷을 정확히 전송
- MAC 주소와 단말이 위치하는 인터페이스 정보를 매핑한 MAC 주소 테이블 보유
- 플러딩, 어드레스 러닝, 포워딩/필터링

## 1. 플러딩(Flooding)

- 모든 포트로 패킷을 흘리는 동작 방식

## 2. 어드레스 러닝(Address Learning)

- MAC 주소 테이블을 만들고 유지하는 과정
- 패킷의 출발지 MAC 주소 정보 이용

## 💭. 사전 정의된 MAC 주소 테이블

- 스위치 간 통신을 위해 사용되는 주소
- 인접 포트 정보가 없거나 CPU 혹은 관리 모듈을 지칭하는 용어로 표기

## 3. 포워딩/필터링(Forwarding/Filtering)

- 도착지 MAC 주소를 확인하고 자신이 가진 MAC 테이블과 비교해 맞는 정보가 있으면 매치되는 해당 포트로 패킷 포워딩
- 필터링 : 다른 포트로는 해당 패킷을 보내지 않음

# 2. VLAN(Virtual Local Area Network)

- 가상화 기술
- 하나의 물리 스위치에서 여러 개의 네트워크를 나누어 사용

## 1. VLAN이란?

- 물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술
- 유니캐스트뿐만 아니라 브로드캐스트도 VLAN 간에 통신할 수 없음 → 통신을 위해 3계층 장비 필요

## 2. VLAN의 종류와 특징

- 포트 기반 VLAN : 스위치를 논리적으로 분할해 사용하는 것, 일반적으로 언급하는 대부분의 VLAN
- MAC 주소 기반 VLAN : 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN 할당, 다이나믹 VLAN

## 3. VLAN 모드(Trunk/Access) 동작 방식

- 한 대의 스위치에 연결되더라도 서로 다른 VLAN이 설정된 포트 간에는 통신 불가
- 각 VLAN끼리 통신하려면 VLAN 개수만큼 포트 연결
- 태그 기능 : 하나의 포트에 여러 개의 VLAN을 함께 전송
    - 태그 포트, 트렁크 포트
    - 이더넷 프레임 중간에 VLAN ID 필드를 끼워 넣어 이 정보를 이용
    - 다른 VLAN끼리 통신하지 못하도록 MAC 테이블에 VLAN을 지정하는 필드 추가
    - VLAN별로 MAC 주소 테이블이 존재하는 것처럼 동작
    - 여러 개의 VLAN, 여러 네트워크를 하나의 물리적 포트로 전달하는 데 사용
    - 태그를 벗겨내면서 태그된 VLAN 쪽으로 패킷 전송
- 언태그 포트, 액세스 포트 : 일반적인 포트
    - 하나의 VLAN이 속한 경우에만 사용
    - 같은 VLAN으로만 패킷 전송

# 3. STP

- SPoF(Single Point of Failure, 단일 장애점) : 하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소
- 네트워크 루프 : 두 대 이상의 스위치로 디자인 → 패킷이 네트워크를 따라 계속 전송 → 네트워크 마비

## 1. 루프란?

- 네트워크에 연결된 모양이 고리처럼 되돌아오는 형태로 구성된 상황

### 1. 브로드캐스트 스톰

- 루프 구조 상태에서는 패킷이 계속 돌아감
- TTL(Time to Live) 패킷 수명 미보유 → 패킷 하나가 전체 네트워크 대역폭 차지
- 네트워크의 전체 대역폭을 차지하고 네트워크에 연결된 모든 단말이 브로드캐스트를 처리하기 위해 시스템 리소스를 사용하면서 스위치와 네트워크에 연결된 단말 간 통신이 거의 불가능한 상태로 변환
- 네트워크에 접속된 단말의 속도 느려짐(CPU 사용률 높아짐)
- 네트워크 접속 속도 느려짐(통신 불가능 수준)
- 네트워크에 설치된 스위치에 모든 LED들이 동시에 빠른 속도로 깜빡임

### 2. 스위치 MAC 러닝 중복 문제

- MAC 어드레스 플래핑(MAC Address Flapping) : 동일한 MAC 주소가 여러 포트에서 학습되면 MAC 테이블이 반복 갱신되어 정상적으로 동작 불가능

## 2. STP란?

- 스패닝 트리 프로토콜(Spanning Tree Protocol) : 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘
- BPDU(Bridge Protocol Data Unit) 프로토콜 : 스위치 간에 정보를 전달하고 이렇게 수집된 정보를 이용해 전체 네트워크 트리를 만들어 루프 구간 확인
    - 스위치가 갖고 있는 ID와 같은 고윳값 들어감
    - 스위치 간에 서로 교환

### 1. 스위치 포트의 상태 및 변경 과정

- 스위치 포트에 신규 스위치가 연결되면 바로 트래픽이 흐르지 않도록 차단
- BPDU를 기다려 학습하고 구조를 파악한 후 트래픽 흘림
- 루프 구조인 경우 차단 상태 유지
- Blocking
    - 패킷 데이터를 차단한 상태, 상대방이 보내는 BPDU 기다림
    - MAX Age 기간 동안 상대방 스위치에서 BPDU를 받지 못했거나 후순위 BPDU를 받았을 떄 포트 → 리스닝 상태로 변경
    - BPDU 기본 교환 주기(2초), 10번의 BPDU 기다림
- Listening
    - 해당 포트가 전송 상태로 변경되는 것을 결정하고 준비하는 단계
    - 자신의 BPDU 정보를 상대방에게 전송
    - 총 15초 동안 대기
- Learning
    - 이미 해당 포트를 포워딩하기로 결정, 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC 주소를 러닝하는 단계
    - 총 15초 동안 대기
- Forwarding
    - 패킷 포워딩하는 단계
    - 정상적인 통신 가능
- 통신하는 데 50여 초 소요
- 이중화된 절체(전환)도 STP의 동작 순서대로 진행

### 2. STP 동작 방식

- 루트 스위치 : 가장 높은 스위치를 선출하고 그 스위치를 통해 모든 BPDU가 교환
- 하나의 루트 스위치 선정
    - 전체 네트워크에 하나의 루트 스위치
    - 자신을 전체 네트워크의 대표 스위치로 적은 BPDU를 옆 스위치로 전달
- 루트가 아닌 스위치 중 하나의 루트 포트 선정
    - 루트 브릿지로 가능, 경로가 가장 짧은 포트 → 루트 포트
    - 루트 브릿지에서 보낸 BPDU 받는 포트
- 하나의 세그먼트에 하나의 지정 포트 선정
    - 스위치와 스위치가 연결되는 포트 → 하나의 지정 포트 선정
    - 스위치 간의 연결에서 이미 루트 포트로 선정 → 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태
    - 스위치 간의 연결에서 아무도 루트 포트가 아닐 경우 한쪽은 지정 포트로 선정, 다른 한쪽은 대체 포트가 되어 차단 상태
    - BPDU가 전달되는 포트

## 3. 향상된 STP(RSTP, MST)

### 1. RSTP(Rapid Spanning Tree Protocol)

- 2 ~ 3초로 절체 시간이 짧아 일반적인 TCP 기반 애플리케이션이 세션 유지 가능
- BPDU 메시지 형식이 다양해져 여러 가지 상태 메시지 교환 가능
- 토폴로지 변경이 일어난 스위치 자신이 모든 네트워크에 토폴로지 변경 직접 전파 가능

### 2. MST(Multiple Spanning Tree)

- CST(Common Spanning Tree) : VLAN 개수와 상관없이 스패닝 트리 한 개만 동작
    - 루프가 생기는 토폴로지에서 한 개의 포트와 회선만 활성화 → 자원을 효율적으로 활용 못함
    - VLAN마다 최적의 경로 다름 → 포트 하나만 사용할 수 있으므로 멀리 돌아 통신해야 할 수도 있음
- PVST(Per Vlan Spanning Tree)
    - VLAN마다 다른 스패닝 트리 프로세스가 동작 → VLAN마다 별도의 경로, 트리 구성 가능
- 여러 개의 VLAN을 그룹으로 묶고 그 그룹마다 별도의 스패닝 트리 동작
- 로드 셰어링 기능도 함께 사용 가능
- 리전 하나가 스패닝 트리 하나
- SLPP(Simple Loop Prevention Protocol)
- Extreme STP
- Loop Guard : STP와 다른 메커니즘으로 루프 확인
- BPDU Guard : BPDU 인입 → 해당 포트 차단
