# 6장. 로드 밸런서 / 방화벽 : 4계층 장비(세션 장비)

# 1. 4계층 장비의 특징

- 세션 장비 : 로드 밸런서, 방화벽
- 세션 테이블
    - 세션 장비 운영
    - 세션 정보를 저장, 확인하는 작업 전반에 대한 이해 필요
    - 세션 테이블에 남아 있는 라이프타임 존재
- Symmetric(대칭) 경로 요구 : Inbound와 Outbound 경로 일치
- 정보 변경(로드 밸런서) : IP 주소 변경, 확장된 L7 로드 밸런서(ADC) 애플리케이션 프로토콜 정보 변경

# 2. 로드 밸런서

- 서버나 장비의 부하 분산을 위해 사용하는 장비
- IP 주소나 4계층 정보, 애플리케이션 정보 확인, 수정하는 기능
- 웹 서버 부하 분산
- 대표 IP 주소를 서비스 IP로 사용 → 로드 밸런서가 각 시스템의 실제 IP로 변경해 요청 보냄
- L4 로드 밸런싱
    - 일반적인 로드 밸런서가 동작하는 방식
    - TCP, UDP 정보(포트 넘버)를 기반으로 로드 밸런싱 수행
    - 장비에서 L7 지원 여부와 상관없이 4계층에 대한 정보로만 분산 처리하는 경우
- L7 로드 밸런싱
    - HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱 수행
    - ADC(Application Delivery Controller) : HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하 분산
    - 프록시(Proxy) 역할 수행
    - 스퀴드(Squid)나 Nginx에서 수행하는 리버스 프록시(Reverse Proxy)와 유사한 기능

## 1. L4 스위치

- 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치
- 부하 분산, 성능 최적화, 리다이렉션 기능 제공
- 가상 IP를 리얼 IP로 변경해주는 역할
    - 가상 서버(Virtual Server) : 사용자가 바라보는 실제 서비스
    - 가상 IP(Virtual IP) : 사용자가 접근해야 하는 서비스 IP 주소
    - 리얼 서버(Real Server) : 실제 서비스를 수행하는 서버
    - 리얼 IP(Real IP) : 실제 서버의 IP

## 2. ADC(Application Delivery Controller)

- 애플리케이션 계층에서 동작하는 로드 밸런서
- 다양한 부하 분산, 정보 수정, 정보 필터링 가능
- 로드 밸런싱 기능을 제공
- 페일오버(Failover, 장애극복 기능), 리다이렉션(Redirection) 기능 수행
- 애플리케이션 프로토콜 이해 및 최적화
- 캐싱(Caching), 압축(Compression), 콘텐츠 변환 및 재작성, 인코딩 변환
- WAF(Web Application Firewall) 기능, HTML, XML 검증 및 변환 수행

## 3. L4 스위치 vs ADC

- L4 스위치
    - TCP, UDP 정보 기반으로 부하 분산
    - TCP 계층에서의 최적화 및 보안 기능
- ADC
    - 애플리케이션 내용에 대한 분산, 리다이렉션, 최적화 제공
    - 정적 콘텐츠 캐싱
    - 하드웨어 가속 및 소프트웨어 최적화
    - SSL 엔드 포인트 동작 → 클라이언트에서 ADC까지의 구간 SSL로 처리, ADC와 웹 서버 사이 HTTP로 통신

## 💭. 시스템 확장 방법 : 스케일 업과 스케일 아웃

- 스케일 업(Scale-Up) : 새로 더 큰 용량의 시스템을 구매해 서비스를 옮기는 방법
    - 부품을 쉽게 추가
    - 시스템 설계 변경 없이 서비스 사용량 증가 가능
    - 부품 추가 어려움
    - 시스템이 커질수록 비용이 기하급수적으로 증가
- 스케일 아웃(Scale-Out) : 같은 용량의 시스템을 여러 대 배치
    - 스케일 업 방식보다 더 적은 비용으로 시스템 확장 가능
    - 여러 대의 시스템에 로드를 적절히 분산해 하나의 시스템에 장애 발생 → 결함허용 구현
    - 별도의 복잡한 아키텍쳐 이해 및 운영
    - 프로세스나 네트워크 장비 추가 필요
- 스케일 다운(Scale-Down) : 기존 시스템보다 작은 용량의 시스템으로 서비스를 옮기는 방법
- 스케일 인(Scale-In) : 여러 개의 서비스를 합쳐 하나의 시스템에서 운영하는 방법

# 3. 방화벽

- 네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용(Permit)하거나 차단(Deny)하는 장비
- 네트워크 3, 4계층에서 동작하고 세션을 인지, 관리하는 SPI(Stateful Packet Inspection) 엔진을 기반으로 동작하는 장비
- 세션 정보를 장비 내부에 저장
- 메모리에 남는 상태와 세션 정보를 이용해 패킷을 상세히 로깅하고 관찰

# 4. 4계층 장비를 통과할 때의 유의점(세션 관리)

- 세션을 이해하고 세션 테이블 유지
- 패킷을 변경하거나 애플리케이션 성능 최적화, 보안 강화 → 패킷 포워드 및 드롭
- 애플리케이션의 세션 시간과 서비스 방향성 고려, 비대칭 경로 회피

## 1. 세션 테이블 유지, 세션 정보 동기화

1. 3방향 핸드셰이크를 통해 정상적으로 세션 설정
    - 방화벽에서 세션 설정 과정을 확인하고 세션 테이블 기록
2. 세션 테이블을 참조해 방화벽에서 패킷 통과
3. 일정 시간 동안 통신 없음
4. 세션 타임으로 세션 테이블 만료
5. 세션 만료 후 애플리케이션 통신 시작
6. 세션이 만료되어 방화벽에서 패킷 드롭

### 1. 세션 장비 운영자 입장

- 세션 만료 시간 증가
    - 애플리케이션의 세션 유지 시간보다 방화벽 세션 유지 시작이 길어야 함
    - 애플리케이션 고유의 세션 유지 시간 미리 공지
- 세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정(세션 장비 중 방화벽에 해당)
    - 세션 테이블에 정보가 없는 ACK 패킷이 들어오더라도 세션을 새로 만들어 통과시킬 수 있는 옵션
- 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보
    - 양 종단 장비의 세션 정보와 중간 세션 장비의 세션 정보가 일치하지 않아 발생하는 문제를 해결하기 위해 사용
    - 세션 정보에 있는 양 종단 장비에 세션 정보 만료 통보
- 세션 만료 시 동작 과정
    1. 세션 설정
    2. 일정 시간 동안 통신 없음
    3. 세션 타임아웃값이 넘어 세션 만료
    4. 방화벽에서 양 종단 장비에 RST 패킷 전송
        - A, B 장비 통신일 경우
        - A 장비에는 출발지 B, 도착지 A인 RST 패킷 전송
        - B 장비에는 출발지 A, 도착지 B인 RST 패킷 전송
    5. RST 패킷을 받은 양 종단 장비는 해당 프로세스 종료

### 2. 개발자 입장

- 애플리케이션에서 주기적인 패킷 발생 기능 추가
    - 중간에 통신이 없더라도 일정 시간마다 양 단말 애플리케이션의 세션 상태 정보를 체크하는 더미 패킷을 보내는 기능
    - 더미 패킷을 주기적으로 보내거나 트래픽이 일정 시간 동안 없을 때만 더미 패킷을 보내거나 더 복잡한 로직을 이용해 애플리케이션 상태를 체크하는 기능 구현

## 2. 비대칭 경로 문제

- 대칭 경로(Symmetric Path) : 인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과
- 비대칭 경로(Asymmetric Path) : 인바운드 패킷과 아웃바운드 패킷이 다른 장비 통과
- 세션 테이블 동기화
    - 패킷 경로를 변경하지 않고 동작
    - 세션 동기화하는 시간보다 패킷 응답이 빠르면 정상적으로 동작 불가능
    - 응답시간이 비교적 긴 인터넷 게이트웨이로 방화벽 사용 시 사용
- 세션 장비에서 다양한 방법으로 보정
    - 다른 세션 장비 쪽으로 패킷을 보내 경로 보정
    - MAC 리라이팅 : 강제로 다른 방화벽으로 패킷을 보내기 위해 방화벽 간 통신용 링크 필요, MAC 주소 변경
    - 터널링 : 기존 패킷에 MAC 주소를 한 번 더 인캡슐레이션

## 3. 하나의 통신에 두 개 이상의 세션이 사용될 때의 고려사항

- 서로 다른 두 세션이 하나의 통신을 위해 사용하고 있다는 것을 네트워크 통신 중간에 놓인 세션 장비도 파악
- 데이터 프로토콜 : 데이터를 실어 나름
- 컨트롤 프로토콜 : 데이터가 잘 전송되도록 세션 제어
- FTP(File Transfer Protocol) : 컨트롤 프로토콜과 데이터 프로토콜 완전히 분리, 통신 방법이 다른 두 가지 모드 사용
    - Active 모드
        - 명령어를 전달하는 컨트롤 프로토콜과 데이터를 전달하는 데이터 프로토콜이 분리, 방향도 반대로 동작
        - 컨트롤 프로토콜은 클라이언트에서 서버로 통신 시작
        - 데이터 프로토콜은 서버에서 클라이언트 쪽으로 데이터 푸시
        - ALG(Application Layer Gateway) : FTP가 동작하는 프로토콜을 모두 이해할 수 있는 별도 기능 동작
    - Passive 모드
        - 컨트롤, 데이터 프로토콜이 분리되어 있는 것은 같음, 클라이언트에서 서버쪽으로 데이터를 요청해 다운받도록 동작
        - FTP 서버에서 Passive 모드에서 사용하는 데이터 포트의 범위 설정 가능
