# 3장. 네트워크 통신하기

# 1. 유니캐스트, 멀티캐스트, 브로드캐스트, 애니캐스트

## 1. 유니캐스트(Unicast)

- 1:1 통신
- 출발지와 목적지가 1:1로 통신

## 2. 브로드캐스트(Broadcast)

- 1:모든 통신
- 동일 네트워크에 존재하는 모든 호스트가 목적지(모든 호스트에 패킷 전달)
- 상대방의 정확한 위치 파악을 위해 사용

## 3. 멀티캐스트(Multicast)

- 1:그룹(멀티캐스트 구독 호스트) 통신
- 하나의 출발지에서 다수의 특정 목적지로 데이터 전송
- 단방향으로 다수에게 동시에 같은 내용 전달 시 사용

## 4. 애니캐스트(Anycast)

- 1:1 통신(목적지는 동일 그룹 내의 1개 호스트)
- 다수의 동일 그룹 중 가장 가까운 호스트에서 응답
- IPv4에서는 일부 기능 구현, IPv6은 모두 구현 가능
- 가장 가까운 DNS 서버 찾을 때, 가장 가까운 게이트웨이 찾을 때 사용

## 💭. 통신 방식 정리

| 타입 | 통신 대상 | 범위 | IPv4 | IPv6 | 예제 |
| --- | --- | --- | --- | --- | --- |
| 유니캐스트 | 1:1 | 전체 네트워크 | ○ | ○ | HTTP |
| 브로드캐스트 | 1:모두 | 서브넷(로컬 네트워크) | ○ | X | ARP |
| 멀티캐스트 | 1:그룹 | 정의된 구간 | ○ | ○ | 방송 |
| 애니캐스트 | 1:1 | 전체 네트워크 | △ | ○ | 6 to 4 DNS |

## 💭. BUM 트래픽

- B(Broadcast), U(Unknown Unicast), M(Multicast) 지칭
    - 언노운 유니캐스트 : 목적지 주소는 명확히 명시, 네트워크에서의 동작은 브로드캐스트와 같음
- 유니캐스트이지만 실제로 겉으로 보이는 동작 방식은 브로드캐스트에 가까움
- 전달받는 모든 단말 NIC에서 도착지 주소를 확인하고 자신이 목적지가 아니므로 패킷을 버림

# 2. MAC 주소

- Media Access Control
- 2계층(데이터 링크 계층)에서 통신을 위해 네트워크 인터페이스에 할당된 고유 식별자
- 이더넷과 와이파이를 포함한 대부분의 IEEE 802 네트워크 기술에서 2계층 주소로 사용

## 1. MAC 주소 체계

- 변경할 수 없도록 하드웨어에 고정되어 출하
- 네트워크 구성 요소마다 다른 주소 보유
- 제조사 코드(Vendor Code) : 네트워크 장비 제조업체에 주소 풀을 할당하는 것
- 48비트의 16진수 12자리로 표현
    - 앞의 24비트 : 제조사 코드, OUI(Organizational Unique Identifier)
    - 뒤의 24비트 : 제조사에서 자체적으로 할당(네트워크에서 각 장비 구분), UAA(Universally Administered Address)
- BIA(Burned-In Address)

## 💭. 유일하지 않은 MAC 주소

- 제조업체 코드 내에서 뒤의 24비트의 UAA 값을 할당 → 실수나 의도적으로 MAC 중복 발생
- 동일 네트워크에서만 중복되지 않으면 동작하는 데 문제 없음
- 라우터에서 다른 네트워크로 넘겨줄 때 출발지와 도착지의 MAC 주소 변경 → 네트워크를 넘어가면 기존 출발지와 도착지 MAC 주소 유지 X

## 2. MAC 주소 동작

- 자신의 MAC 주소를 가지고 있고 전기 신호가 들어오면 2계층에서 데이터 형태(패킷)로 변환 → 내용 구분 후 도착지 MAC 주소 확인
- 도착지 MAC 주소가 자신이 갖고 있는 MAC 주소와 다름 → 그 패킷 폐기
- 패킷의 목적지 주소가 자기 자신이거나 브로드캐스트, 멀티캐스트와 같은 그룹 주소 → 처리해야 할 주소로 인지, 패킷 정보를 상위 계층으로 전달

## 💭. 무차별 모드(Promicuous Mode)

- 자신의 MAC 주소와 일치하지 않는 도착지 주소를 가짐 → 자체적으로 폐기
- 다른 목적지를 가진 패킷을 분석하거나 수집 → 무차별 모드로 NIC 구성
- 자신의 MAC 주소와 상관없는 패킷이 들어와도 이를 분석할 수 있도록 메모리에 올려 처리

# 3. IP 주소

- 2계층 : 물리 주소인 MAC 주소 사용
- 3계층 : 논리 주소인 IP 주소 사용
- 사용자가 변경 가능한 논리 주소
- 주소에 레벨 보유, 그룹을 의미하는 네트워크 주소, 호스트 주소

## 1. IP 주소 체계

- IPv4(32비트, 주로 사용), IPv6(128비트)
- 4개의 옥텟(8비트 단위), 각 옥텟은 `.` 로 구분(서브넷 마스크)
- 네트워크 주소 : 호스트들을 모은 네트워크를 지칭하는 주소, 로컬 네트워크(네트워크 주소 동일)
- 호스트 주소 : 하나의 네트워크 내에 존재하는 호스트를 구분하기 위한 주소
- 네트워크 주소와 호스트 주소의 구분하는 경계점 고정 X
- 필요한 호스트 IP 개수에 따라 네트워크의 크기를 다르게 할당할 수 있는 클래스 개념 도입
    - A 클래스(약 1600만 개, 첫 번째 옥텟에 구분자)
        - 첫 옥텟이 0 0000000 ~ 0 1111111인 주소
        - 127만 예외로 루프백 주소(자신 의미)
        - 1.0.0.0 ~ 126.255.255.255
    - B 클래스(약 6만 5천 개, 두 번째 옥텟에 구분자
        - 첫 옥텟이 10 000000 ~ 10 111111인 주소
        - 128.0.0.0 ~ 191.255.255.255
    - C 클래스(약 250개, 세 번째 옥텟에 구분자)
        - 첫 옥텟이 110 00000 ~ 110 11111인 주소
        - 192.0.0.0 ~ 223.255.255.255
    - D 클래스 : 멀티캐스트(Multicast)
        - 224.0.0.0 ~ 239.0.0.0
    - E 클래스 : 예약(Reserved for futures)
- 다른 고정된 네트워크 주소 체계에 비해 주소 절약 가능

## 2. 클래스풀과 클래스리스

- 클래스풀(Classful) : 클래스 기반의 IP 주소 체계
- 네트워크 주소와 호스트 주소를 구분짓는 구분자(서브넷 마스크)가 불필요

### 1. 클래스리스 네트워크의 등장

- 클래스리스, CIDR(Classless Inter-Domain Routing)
- NAT와 사설 IP 주소
- 차세대 IP인 IPv6
- 할당받은 조직에서 이 주소들을 제대로 사용하지 못하면서 낭비하는 것 → 클래스 개념 자체를 버림
- 서브넷 마스크(Subnet Mask) : 별도로 네트워크와 호스트 주소를 나누는 구분자 사용
    - 숫자 1은 네트워크 주소, 0은 호스트 주소로 표시
    - 255는 네트워크 주소 부분, 0은 호스트 주소 부분

## 3. 서브네팅(Subnetting)

- 원래 부여된 클래스의 기준을 무시하고 새로운 네트워크-호스트 구분 기준을 사용자가 정해 원래 클래스풀 단위의 네트워크보다 더 쪼개 사용하는 것
- 네트워크 디자인 단계에서 네트워크 설계자가 네트워크를 효율적으로 어떻게 분할할 것인지 계획
- 이미 분할된 네트워크에서 사용자가 자신의 네트워크와 원격지 네트워크 구분
- 네트워크 사용자 입장
    - 네트워크에서 사용할 수 있는 IP 범위 파악
    - 기본 게이트웨이와 서브넷 마스크 설정이 제대로 되어 있는지 확인
- 네트워크 설계자 입장
    - 네트워크 설계 시 네트워크 내에 필요한 단말을 고려한 네트워크 범위 설계

### 1. 네트워크 사용자의 서브네팅

1. 자신이 속한 네트워크의 유효 범위 파악 방법
- 내 IP를 2진수로 표현
- 서브넷 마스크를 2진수로 표현
- 2진수 AND 연산으로 서브네팅된 네트워크 주소 알아내기
- 호스트 주소 부분을 2진수 1로 모두 변경해 브로드캐스트 주소 알아내기
- 유효 IP 범위 파악, 서브네팅된 네트워크 주소 + 1(유효 IP 중 가장 작은 IP)
- 브로드캐스트 주소 - 1(유효 IP 중 가장 큰 IP)
- 2진수로 연산되어 있는 결괏값을 10진수로 변환

1. 좀 더 쉽게 서브네팅하고 자신이 속한 네트워크 범위 파악하는 방법
- 서브넷 마스크를 2진수로 변환
- 현재의 서브넷이 가질 수 있는 최대 IP 개수 크기 파악(64)
- 64의 배수로 나열하여 기준이 되는 네트워크 주소 파악
    - 첫 블록은 0부터 시작
    - 각 네트워크의 마지막 주소가 브로드캐스트 주소
    - 다음 블록 네트워크 주소의 -1 수
    - 0 ~ 63 / 64 ~ 127 / 128 ~ 191 / 192 ~ 255
- IP 주소에서 호스트 주소가 속한 네트워크 선택
- 필요한 주소 정리(네트워크 주소, 브로드캐스트 주소, 유효 IP 범위)

### 2. 네트워크 설계자 입장

- 서브넷된 하나의 네트워크에 IP를 몇 개나 할당해야 하는가
- 서브넷된 네트워크가 몇 개나 필요한가

## 4. 공인 IP와 사설 IP

- 공인 IP : 전 세계에서 유일한 식별자
- 사설 IP : 인터넷에 연결하지 않고 개인적으로 네트워크 구성
    - IP를 변환해주는 NAT 장비에서 공인 IP로 변경한 후에는 인터넷 접속 가능
    - A 클래스 1개, B 클래스 16개, C 클래스 256개 사용 가능
- Bogon IP : 여러가지 목적으로 예약해놓아 공인 IP로 할당되지 않는 주소

# 4. TCP와 UDP

## 1. 4계층 프로토콜(TCP, UDP)과 서비스 포트

- 각 계층에서 정의하는 정보 : 수신 측의 동일 계층에서 사용하기 위한 정보
- 상위 프로토콜 지시자 정보 : 디캡슐레이션 과정에서 상위 계층의 프로토콜이나 프로세스를 정확히 찾아가기 위한 목적(2계층 이더 타입, 3계층 프로토콜 번호, 4계층 포트 번호)
- 목적지를 찾아가는 주소가 아니라 애플리케이션에서 사용하는 프로세스를 정확히 찾아가고 데이터를 분할한 패킷을 잘 쪼개 보내고 잘 조립하는 것
- 4계층 상위 프로토콜 지시자 : 포트 번호 → 출발지와 목적지를 구분해 처리
- 웰 노운 포트 : HTTP TCP 80, HTTPS TCP 443, SMTP TCP 25 등 잘 알려진 포트

## 2. TCP

- 신뢰할 수 없는 공용망에서도 정보유실 없는 통신을 보장하기 위해 세션을 안전하게 연결하고 데이터를 분할하고 분할된 패킷이 잘 전송되었는지 확인하는 기능

### 1. 패킷 순서, 응답 번호

- 분할된 패킷을 잘 분할하고 수신 측이 잘 조합하도록 패킷에 순서를 주고 응답 번호 부여
- 시퀀스 번호 : 패킷에 순서를 부여하는 것
- ACK 번호 : 응답 번호를 부여하는 것

### 2. 윈도 사이즈와 슬라이딩 윈도

- 윈도 사이즈 : 한 번에 데이터를 받을 수 있는 데이터 크기
- 슬라이딩 윈도 : 네트워크 상황에 따라 윈도 사이즈를 조절하는 것

### 3. 3방향 핸드셰이크

- 통신 전, 데이터를 안전하게 보내고 받을 수 있는지 미리 확인하는 작업
- 3방향 핸드셰이크 : 3번의 패킷을 주고받으면서 통신을 서로 준비
- LISTEN 상태 : 서버에서 서비스를 제공하기 위해 클라이언트의 접속을 받아들일 수 있는 상태
- SYN-RECEIVE 상태 : 클라이언트의 SYN을 받은 서버, SYN, ACK로 응답
- ESTABLISHED 상태 : 응답을 받은 클라이언트, 그에 대한 응답을 서버로 다시 보냄 → 서버와 클라이언트 간의 연결이 성공적으로 완료
- 플래그 : 어떤 패킷이 새로운 연결 시도이고 기존 통신에 대한 응답인지 구분
    - SYN : 연결 시작 용도, SYN 플래그에 1로 표시
    - ACK : ACK 번호 유효 시 1로 표시, 초기 SYN이 아닌 모든 패킷은 기존 메시지에 대한 응답(1로 표기)
    - FIN : 연결 종료 시 1로 표시, 정상적으로 양방향 종료 시 사용
    - RST : 연결 종료 시 1로 표시, 연결을 일방적으로 끊을 때 사용
    - URG : 긴급 데이터, 1로 표시
    - PSH : 서버 측에서 전송할 데이터가 없을 때, 데이터를 버퍼링 없이 응용 프로그램으로 즉시 전달할 때

## 3. UDP

- 데이터 전송을 보장하지 않는 프로토콜 → 제한된 용도로만 사용
- 단방향으로 다수의 단말과 통신해 응답을 받기 어려운 환경에서 주로 사용
- 중간에 데이터가 일부 유실되더라도 그냥 유실된 상태로 데이터 처리
- 첫 데이터는 리소스 확보를 위해 인터럽트를 거는 용도로 사용되고 유실

| TCP | UDP |
| --- | --- |
| 연결 지향(Connection Oriented) | 비연결형(Connectionless) |
| 오류 제어 수행함 | 오류 제어 수행 안 함 |
| 흐름 제어 수행함 | 흐름 제어 수행 안 함 |
| 유니캐스트 | 유니캐스트, 멀티캐스트, 브로드캐스트 |
| 전이중(Full Duplex) | 반이중(Half Duplex) |
| 데이터 전송 | 실시간 트래픽 전송 |

# 5. ARP(Address Resolution Protocol)

- 상대방의 MAC 주소를 알아내기 위해 사용되는 프로토콜

## 1. ARP란?

- IP 주소 체계는 물리적 MAC 주소와 전혀 연관성이 없으므로 두 개의 주소를 연계시켜 주기 위한 메커니즘 필요
- ARP 브로드캐스트를 받은 목적지는 ARP 프로토콜을 이용해 자신의 MAC 주소 응답
- ARP 테이블 저장 기간을 일반 PC보다 길게 설정하고 많은 ARP 요청이 들어오면 이를 필터링하거나 천천히 처리하는 방식
- ARP 테이블을 수동으로만 갱신하도록 설정

## 2. ARP 동작

- 송신자 하드웨어 MAC 주소, 송신자 IP 프로토콜 주소, 대상자 MAC 주소, 대상자 IP 프로토콜 주소
- ARP 요청을 처음 보낼 때 : 브로드캐스트
- ARP 응답을 보낼 때 : 출발지와 도착지 MAC 주소가 명시되어 있는 유니캐스트

## 3. GARP(Gratuitous ARP)

- GARP, RARP : 내용을 변경해 원래 ARP 프로토콜의 목적과 다른 용도로 사용
- 대상자 IP 필드에 자신의 IP 주소를 채워 ARP 요청 보냄
- 자신의 IP와 MAC 주소를 알릴 목적으로 사용
- 목적지 MAC 주소(2계층 Destination MAC)는 브로드캐스트 MAC 주소 사용
- 송신자 MAC(Sender MAC) : 자신의 MAC 주소
- 송신자 IP(Sender IP) : 자신의 IP 주소
- 대상자 MAC(Target MAC) : 모두 0, 00:00:00:00:00:00
- 대상자 IP(Target IP) : 자신의 IP 주소

### 1. IP 주소 충돌 감지

- IP가 네트워크에서 이미 사용되고 있는지 GARP를 통해 확인
- GARP에 대한 응답 → 네트워크상에서 해당 IP를 이미 사용 중

### 2. 상대방(동일 서브넷에 있는)의 ARP 테이블 갱신

- 가상 MAC 주소를 사용하지 않는 데이터베이스 HA(High Availability) 솔루션에서 주로 사용
- 두 대의 데이터베이스 중 한 대만 동작하고 나머지 한 대는 대기하는 액티브-스탠바이(Active-Standby)로 동작

### 3. 클러스터링, FHRP(VRRP, HSRP)

- 장비 이중화를 위해 사용되지만 실제 MAC 주소를 사용하지 않고 가상 MAC을 사용하는 클러스터링, VRRP, HSRP와 같은 FHRP(First Hop Redundancy Protocol)에서도 사용
- 네트워크에 있는 스위치 장비의 MAC 테이블 갱신 목적
- 슬레이브가 마스터로 역할이 변경 → GARP 전송, 스위치에서는 GARP를 통해 MAC 주소에 대한 포트 정보를 새로 변경 후 MAC 테이블 갱신

## 4. RARP(Reverse ARP)

- 반대로 동작하는 ARP
- ARP 프로토콜 구조는 같지만 필드에 들어가는 내용이 다르고 원래 목적과 반대로 사용
- IP 주소가 정해져 있지 않은 단말이 IP 할당을 요청할 때 사용
- 자신의 MAC 주소는 알지만 IP가 아직 할당되지 않아 IP를 할당해주는 서버에 어떤 IP 주소를 써야 하는지 물어볼 때 사용

# 6. 서브넷과 게이트웨이

## 1. 서브넷과 게이트웨이의 용도

- 게이트웨이(Gateway) : 원격 네트워크 통신은 네트워크를 넘어 전달되지 못하는 브로드캐스트의 성질 때문에 네트워크 장비의 도움 필요
- 기본 게이트웨이(Default Gateway) : PC나 네트워크 장비에 설정하는 항목
    - 3계층 장비가 수행
    - 여러 네트워크와 연결되면서 적절한 경로를 지정
    - 출발지에서는 먼저 목적지가 자신이 속한 네트워크의 범위인지 확인하는 작업 필요
- 서브넷 마스크 : 동일 네트워크 간의 통신과 서로 다른 네트워크 간의 통신을 구분
- 프록시 ARP : ARP를 대행해주는 기능
    - 프록시 ARP가 활성화된 기본 게이트웨이는 ARP 브로드캐스트가 들어오면 자신이 대행해 ARP 응답 해줌 → 원격지 경로로 전달

## 2. 2계층 통신 vs 3계층 통신

- 로컬 네트워크 통신, 원격지 네트워크 통신
- L2 : 단말 간을 연결해주는 네트워크 장비에서 2계층까지만 정보를 확인해 통신하고 ARP 요청을 보낼 때 직접 브로드캐스트 이용
- L3 : 원격지 네트워크와 통신해야 할 경우(출발지와 목적지가 다른 네트워크에 존재할 경우), 라우터와 같은 3계층 장비의 도움이 없으면 통신 불가
- 로컬과 리모트 통신을 위한 ARP 동작 방식이 다른 것으로 인해 발생
- 같은 네트워크에 있는 단말 간 통신 : 상대방의 MAC 주소를 알아내기 위해 ARP 브로드캐스트 이용, 상대방의 MAC 주소를 알아내자마자 패킷이 캡슐화되어 통신 시작
- 외부 네트워크와 통신 : 단말이 자신이 직접 보낼 수 없는 위치에 목적지가 있다 판단 → ARP 요청을 기본 게이트웨이의 IP 주소로 요청 → 도착지 MAC 주소에 응답받은 기본 게이트웨이의 MAC 주소를 적어놓고 통신 시작
- 로컬 통신 : 도착지 MAC 주소와 도착지 IP 주소 동일
- 원격지 통신 : 도착지 MAC 주소와 도착지 IP 주소 다름
